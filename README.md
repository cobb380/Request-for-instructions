# Google Apps Script：訪問看護指示書依頼データ処理・帳票生成スクリプト

## 概要

このスクリプトは、Google スプレッドシートを利用して、訪問看護ステーション業務の以下の作業を自動化するものです：

- 指示書期間でデータをフィルタリング
- サービス終了・中止利用者を除外
- 来月依頼分のテンプレートシートを作成
- データを転記・日付を和暦から西暦に変換
- 医療機関ごとの「送り状」「指示書」シートを自動生成
- 医療機関情報の自動差し込み

---

## 構成と処理フロー

### `main()`

- 処理全体の実行関数。以下の順に関数を呼び出します：
  1. `filterSheetByDate()`：日付フィルタ適用（令和表記での判定）
  2. `removeRowsBasedOnConditions()`：終了・中止利用者の削除
  3. `copySheetWithFormattedName()`：来月の依頼シートを作成
  4. `copyDataToBaseSheet()`：依頼シートへ必要情報を転記し、和暦→西暦変換

---

### `executeTask()`

- 「R[年].[月]月依頼分」シートから、**医療機関ごと**に以下の帳票を自動生成します：

  1. 医療機関ごとの「送り状」タブの作成（センター南の有無で分岐）
  2. 10行超のデータがある場合、テンプレートのレイアウトを維持して2段構成で貼り付け
  3. 該当する医療機関が「指示書フォーマット同封」シートにあれば、「指示書」テンプレートもコピー
  4. 医療機関リストから法人名、郵便番号、住所を転記（`copyValuesFromMedicalInstitutionList()`）

---

## 関数別の説明

### データフィルタ・整形関連

| 関数名 | 説明 |
|--------|------|
| `filterSheetByDate()` | 実行月の15日～翌月14日で日付をフィルタ（令和形式） |
| `getVisibleDates()` | 上記期間の日付リスト（令和形式）を生成 |
| `removeRowsBasedOnConditions()` | 「終了・中止」シートから該当利用者を除外 |
| `copySheetWithFormattedName()` | 「フォーマット原本」から `R[年].[月]月依頼分` シートを作成 |
| `copyDataToBaseSheet()` | フィルタ済みデータを依頼シートへ転記。G列・E列の日付を西暦変換 |
| `convertJapaneseEraToGregorian()` | 和暦日付（例：令和6年6月1日）を西暦のDate型に変換 |

---

### 帳票生成・シートコピー関連

| 関数名 | 説明 |
|--------|------|
| `executeTask()` | 「R[年].[月]月依頼分」シートから医療機関ごとに「送り状」「指示書」タブを作成 |
| `copyValuesFromMedicalInstitutionList()` | 医療機関リストから法人名や住所を各シートに反映 |
| `findSheetByNamePart()` | 部分一致でシートを検索するユーティリティ関数 |

---

## 使用方法

1. スプレッドシートにこのスクリプトを貼り付ける
2. 必要に応じて、以下のシートを準備
   - フォーマット原本
   - HNC09000P1 を含むデータシート
   - 終了・中止
   - 指示書フォーマット同封
   - 指示書
   - 医療機関リスト
   - 送り状 / 送り状 (センター南)
3. スクリプトエディタから `main()` → `executeTask()` の順で手動実行

---

## シート命名ルール

- `R[令和年].[月]月依頼分`：データ取り込み対象
- 医療機関名または `医療機関名（南）`：生成される送り状のタブ名
- `医療機関名 指示書`：条件一致時に生成される指示書タブ

---

## 注意点

- 各シートの列名や構成が前提条件と異なると動作しません
- 「令和」表記の日付を扱うため、日付形式が正しくないと失敗します
- センター南判定は「2事業所」列の値の有無で判断されます

---
